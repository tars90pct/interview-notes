# Streams/Event Sourcing

有時候，您會被問到需要即時處理大量資料，或支援複雜的處理情境（例如事件溯源）的問題。

事件溯源是一種技術，將應用程式狀態的變更儲存為一系列事件。這些事件可以被重播，以重建應用程式在任何時間點的狀態，使其成為需要詳細稽核追蹤或能夠反轉或重播交易的系統的有效策略。

無論哪種情況，您都可能需要使用串流。與訊息佇列不同，串流可以將資料保留一段可配置的時間，允許消費者從同一位置或過去的指定時間讀取和重新讀取訊息。串流是一個很好的選擇

## Event Sourcing核心概念

- 將應用程式狀態變化以事件序列形式永久儲存，可透過重新執行（replay）事件重建任意時間點的系統狀態
- 以事件為核心：系統狀態的變更不再直接覆寫資料，而是以「事件物件」形式持久化儲存。例如「訂單已建立」、「付款成功」、「庫存扣減10單位」等事件按發生順序記錄。
- 狀態重建：系統當前狀態可透過依序回放所有歷史事件重新計算得出。這提供了極高的可追溯性，並能輕鬆實現「時光機」功能，支援交易rollback與狀態重建，還原任意時間點的狀態。
- 審計與除錯優勢：每個狀態變化都有明確記錄，便於追蹤問題根源或滿足合規性要求。

## Stream Processing的關鍵價值

- 持續性資料管道：與傳統訊息佇列（Message Queue）相比，串流平臺（如Kafka、Pulsar）提供「持久化儲存」機制，訊息可根據策略保留數天甚至永久，消費者能自由回放歷史資料。
- 分散式擴展能力：透過分區（Partition）機制水平擴展吞吐量，適合處理高速產生的資料流（如IoT裝置資料、即時交易記錄）。
- 複雜事件處理：結合流處理框架（如Flink、Spark Streaming）可實現視窗計算（統計過去5分鐘的異常交易）、模式匹配（偵測特定事件序列）等進階分析。

## Stream vs Message Queues

| 特性       | 串流處理系統       | 傳統訊息佇列   |
| ---------- | ------------------ | -------------- |
| 數據保留   | 可配置保留期限     | 消費後立即刪除 |
| 讀取模式   | 多消費者可重複讀取 | 單次消費機制   |
| 延遲敏感度 | 次秒級延遲         | 毫秒級延遲     |
| 典型應用   | 複雜事件處理       | 任務隊列管理   |

## 延伸知識：

- Scaling with Partitioning
  - 機制： 如同資料庫分片(Sharding)，串流系統可透過將資料分散到多個分區(Partition)實現水平擴展。每個分區由獨立的消費者(Consumer)處理，提升系統吞吐量。
  - Partition Key： 需謹慎選擇分區鍵 (例如使用者ID、訂單編號) 將關聯事件路由至同一分區，維持事件順序性 (Event Ordering) ，例如同一使用者的訂單事件需依序處理以避免狀態錯誤。
- Multiple Consumer Groups
  - 獨立消費能力：不同消費者群組可獨立讀取同一串流，各群組維護自身的消費位移 (Offset)，實現資料多元應用。例如：
    - 群組A： 即時處理交易事件，更新儀表板。
    - 群組B： 將事件儲存至資料湖(Data Lake)供後續批次分析。
  - 模式延伸： 可結合Pub/Sub模式，將串流資料同時推送至訊息佇列(如RabbitMQ)滿足不同子系統需求。
- Replication
  - 高可用性設計：透過跨節點複寫資料 (例如Kafka的ISR機制)，即使節點故障，仍能從其他副本讀取資料，避免服務中斷。
  - 一致性權衡：根據業務場景選擇適當的一致性等級 (強一致性/最終一致性)。例如金融交易需強一致性，而社群媒體動態可接受最終一致性。
- Windowing
  - Time Window：滑動視窗(Sliding Window)、跳躍視窗(Tumbling Window) 常見於時間相關統計，例如：
    - 每5分鐘計算過去1小時的平均網站回應時間 (滑動視窗)
    - 每日凌晨統計前日訂單總額 (跳躍視窗)
  - Count-based Window：每累積1000筆事件觸發處理，適用於高吞吐量場景，例如即時異常檢測。
