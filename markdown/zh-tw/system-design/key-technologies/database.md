# Database

在系統設計面試中，幾乎所有問題都會涉及資料儲存，雖然資料庫有很多不同的類型，但最常見的是關聯式資料庫（例如 Postgres）和 NoSQL 資料庫（例如 DynamoDB）——建議面試時擇一使用。若以產品設計類面試為主，推薦選擇關聯式資料庫；若側重基礎架構設計面試，則建議採用 NoSQL 資料庫。

::TIPS
許多應試者會試圖在回答中強行加入兩者的比較，反而弄巧成拙。事實上這兩種技術存在高度重疊性，而像「我需要使用關聯式資料庫，因為我的資料中有關聯」（NoSQL 也能處理關聯，如 DynamoDB 的單表設計）或「我必須使用 NoSQL，因為我需要擴展性和效能」（現代關聯式資料庫如 PostgreSQL 透過分片與讀寫分離也能高效擴展）這類籠統說法往往會暴露經驗不足的警訊。

多數面試官並不期待候選人主動比較 SQL 與 NoSQL 資料庫，這反而是應該完全避開的陷阱。正確做法是專注說明選擇的資料庫特性如何解決當前問題。若被要求比較，應聚焦實際使用經驗中的差異及其對設計的影響。例如「此處採用 Postgres 因其 ACID 特性可確保資料完整性」就是優質回答範例，既能展現技術理解，又能緊扣題目需求。

## 解釋取捨要點

- 選擇理由具體化：例：「選用 Cassandra 因其寫入優化與跨資料中心複製能力，適合全球用戶的即時日誌收集。」
- 一致性權衡：說明業務場景對一致性的容忍度（如「允許商品庫存短暫不一致，但最終會同步」）。
- 分片設計：解釋分片鍵選擇邏輯（如「按用戶 ID 雜湊分片，避免熱點問題」）。
- 小型系統使用 NoSQL 反而增加維運成本（如 Cassandra 集群管理）。

::

## Relational Databases

關聯式資料庫（又稱 RDBMS，關聯式資料庫管理系統）是最常見的資料庫類型，通常用於處理交易型數據（如用戶紀錄、訂單紀錄等），也是產品設計面試中的預設首選。其核心特性是將資料儲存於「表格」（Tables）中，表格由「行」（Rows）與「列」（Columns）組成：

- 行（Row）：代表一筆獨立紀錄（如一位用戶）。
- 列（Column）：代表紀錄的某個欄位（如 姓名、電子郵件）。

關聯式資料庫使用 SQL（結構化查詢語言） 進行資料操作，這是一種宣告式語言，專為查詢與管理資料設計。

- 核心特性

  - ACID 特性：
    - 原子性（Atomicity）：交易內操作全部成功或全部失敗。
    - 一致性（Consistency）：交易後資料符合所有約束（如外鍵、唯一性）。
    - 隔離性（Isolation）：並行交易互不干擾（可設定隔離等級）。
    - 持久性（Durability）：交易提交後，資料永久保存。
  - SQL Joins：
    - 合併多個表格的資料（例如結合**用戶資料表**與**訂單資料表**，查詢某用戶的所有訂單）。
    - 聯結可能成為效能瓶頸（尤其是多表聯結），需謹慎使用。可透過「反正規化」（Denormalization）或「預先計算」(Materialized View)減少聯結需求。
  - Indexes
    - 加速特定欄位的查詢速度（如為email 建立索引，快速搜尋電子郵件）
    - 支援多種索引類型：B-Tree（預設）、Hash、全文索引、地理空間索引等。
    - 可建立複合索引（如 (country, age) 加速「某國家某年齡段用戶」查詢）。
    - 寫入時需更新索引，可能降低寫入吞吐量
  - Transactions
    - 將多個操作包裝為原子性（Atomic）單元，確保「全有或全無」執行。
    - 若任一操作失敗，整個交易將回滾（Rollback），避免「訂單對應到不存在的用戶」。
    ```
    BEGIN TRANSACTION;
    INSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com');
    INSERT INTO orders (user_id, amount) VALUES (LAST_INSERT_ID(), 100);
    COMMIT;
    ```

- 常見RDB
  - PostgreSQL
    - 功能完整、支援 JSONB、向量距離計算、地理空間資料、自訂資料類型。
  - MySQL
    - 輕量、讀取效能優化、社群支援廣泛。
- 設計要點：
  - 正規化（Normalization）：減少資料冗餘，但需權衡查詢效能（聯結次數）。
  - index策略：對高頻查詢欄位建立索引，避免過度索引影響寫入效能。
  - 讀寫分離：主庫（Master）處理寫入，從庫（Replica）處理讀取，分散負載。
  - 分庫分表：水平拆分（如按用戶 ID 雜湊）以處理海量資料。
  - 擴展性：
    - 垂直擴展：升級單一伺服器硬體（CPU、記憶體、SSD）。
    - 水平擴展：
      - 分片（Sharding）：將資料分散至多個資料庫實例（如 Vitess）。
      - 聯結限制：分片後跨分片聯結需應用層處理，或採用「聯結預計算」。

## NoSQL

NoSQL 資料庫是一個廣泛的資料庫類別，旨在容納各種資料模型，包括key-value, document, column-family, and graph formats。與關聯式資料庫不同，NoSQL 資料庫不使用傳統的表格結構，並且通常是無結構描述的。這種彈性使 NoSQL 資料庫能夠處理大量非結構化、半結構化或結構化資料，並輕鬆地進行水平擴展。

在以下情況下，NoSQL 資料庫是強而有力的選擇：

- Data Models： 您的資料模型正在演變，或者您需要儲存不同類型的資料結構，而無需固定的結構描述。
- 可擴展性： 您的應用程式需要水平擴展（跨多個伺服器），以容納大量資料或高使用者負載。
- 處理大數據和即時網路應用程式： 您的應用程式處理大量資料，尤其是非結構化資料，或者需要即時資料處理和分析。

::TIPS
NoSQL 資料庫擅長的領域不一定就是關聯式資料庫失敗的領域（反之亦然）。例如，雖然 NoSQL 資料庫非常適合處理非結構化資料，但關聯式資料庫也可以使用具有彈性結構描述的 JSON 欄位。雖然 NoSQL 資料庫非常適合水平擴展，但關聯式資料庫也可以透過正確的架構進行水平擴展。當您在系統設計面試中討論 NoSQL 資料庫時，請確保您不是在做籠統陳述，而是討論您正在使用的資料庫的特定功能，以及它們如何幫助您解決手頭的問題。
::

- Data Models

  常見model可分為四大類型

  - Key-Value Stores
    - 鍵（Key）對應單一值（Value），無複雜結構
    - 代表技術：Redis（記憶體型）、DynamoDB（雲端託管）。
    - 應用場景：快取、會話儲存、簡單配置管理。
  - Document Stores
    - 儲存結構：JSON/BSON 格式文件，支援巢狀資料。
    - 代表技術：MongoDB、Couchbase。
    - 應用場景：內容管理系統、產品目錄（非結構化資料）。
  - Column-Family Stores
    - 儲存結構：按列族（Column Family）組織資料，適合稀疏矩陣。- 代表技術：Cassandra、HBase。
    - 應用場景：時間序列資料（如感測器日誌）、寬表查詢（如社交媒體貼文）。
  - Graph Databases
    - 儲存結構：以節點（Node）與關係（Edge）表示資料網絡。
    - 代表技術：Neo4j、Amazon Neptune。
    - 應用場景：社交關係分析、詐騙偵測（複雜關聯路徑查詢）。

- Consistency Models

  NoSQL 資料庫提供多種一致性層級，需依業務需求選擇：

  - 強一致性（Strong Consistency）：
    - 所有節點即時同步資料，寫入後讀取必定取得最新值。
    - 適用場景：金融交易、庫存管理（如 DynamoDB 強一致性讀取）。
    - 代價：可能增加延遲（需等待多節點確認）。
  - 最終一致性（Eventual Consistency）：
    - 資料最終會同步至所有節點，但短時間內可能讀到舊值。
    - 適用場景：社交媒體貼文、評論系統（容忍短暫不一致）。
    - 工具範例：Cassandra 預設行為、DynamoDB 標準讀取模式。

- Indexing

  NoSQL 資料庫支援多種索引策略以加速查詢：

  - B樹索引（B-Tree Index）：
    - 適用範圍查詢（如時間區間、數值範圍）。
    - 範例：MongoDB 預設索引類型。
  - 雜湊索引（Hash Index）：
    - 適用精確查詢（如主鍵查詢），效能 O(1)。
    - 範例：Redis 鍵值查詢、DynamoDB 分區鍵（Partition Key）。
  - 複合索引（Composite Index）：
    - 結合多欄位加速查詢（如 (user_id, timestamp)）。
    - 範例：Cassandra 的複合主鍵設計。
  - 特殊索引（Specialized Indexes）：
    - 全文索引：Elasticsearch（基於 Lucene）支援文字搜索。
    - 地理空間索引：MongoDB 的 2dsphere 索引支援位置查詢。

- Scalability

  NoSQL 資料庫透過分散式設計實現水平擴展

  - Consistent Hashing
    - 資料分佈於環狀雜湊空間，增減節點時僅影響局部資料。
    - 工具範例：DynamoDB 分區鍵雜湊分配。
  - Sharding
    - 將資料水平拆分至多個分片（Shard），每分片獨立運作。
    - 分片鍵選擇策略：
      - 隨機分片：均勻分散負載（如 MongoDB 的 Hashed Sharding）。
      - 範圍分片：按特定欄位範圍分配（如時間分片）。
    - 工具範例：Cassandra 的 Token Range 分片機制。

## NoSQL vs. Relational Databases的設計取捨

- Relational Databases
  - 固定 Schema，需預先定義結構
  - 強一致性（ACID 保證）
  - 垂直擴展為主，水平擴展需手動分庫分表
  - 查詢能力強大（SQL 支援複雜聯結與聚合）
  - 適合交易處理、複雜業務邏輯、強一致性需求
- NoSQL
  - 無 Schema 限制
  - 一致性可配置（強一致性到最終一致性）
  - 水平擴展（自動分片）
  - 查詢能力受限（需依資料模型設計查詢模式）
  - 適合高吞吐寫入、非結構化資料、分散式系統

## Blob Storage

當系統需儲存大型非結構化資料（如圖片、影片、檔案）時，傳統資料庫並非理想選擇——其儲存成本高且效率低下。此時應使用專為大型二進位物件設計的 Blob 儲存服務，如 Amazon S3 或 Google Cloud Storage。

- 運作原理：

  - 上傳與存取：
    - 上傳檔案至 Blob 儲存後，系統回傳唯一 URL。
    - 透過此 URL 可隨時下載原始檔案。
  - CDN 整合：
    - 將 Blob 儲存設為來源站（Origin），透過 CDN 快取檔案至全球邊緣節點，加速下載。
  - 上傳流程
    1. 用戶端請求階段 - 當用戶端需上傳檔案時，向伺服器發送預簽章 URL(presigned URL)生成請求。
    2. 簽發憑證階段 - 伺服器經身分驗證與權限檢查後，生成具時效性的預簽章 URL (有效時間通常為 5 分鐘，可依業務需求調整)，並將此 URL 的 metadata(包含: 檔案唯一識別碼、關聯使用者 ID、有效期限等) 記錄於資料庫的 upload_records 資料表。
    3. 直傳儲存階段 - 用戶端透過 HTTP PUT 方法將檔案直接上傳至雲端 blob 儲存服務 (如 Amazon S3/Azure Blob Storage) 的指定儲存桶(bucket)，繞過伺服器中繼處理實現高效傳輸。
    4. 事件通知階段 - 儲存服務透過 Webhook/SQS 訊息佇列通知伺服器上傳完成事件，伺服器更新檔案狀態為「已就緒」並寫入 files 主表，同時觸發後續處理流程 (如: 產生縮圖、寫入審核佇列等)
  - 下載流程
    1. 憑證核發階段 - 用戶端提交檔案下載請求後，伺服器驗證檔案存取權限，從資料庫檢索檔案路徑 (如: s3://project-bucket/user_uploads/abc123.jpg)，生成具讀取權限的預簽章 URL (有效時間建議 30 秒以強化資安)。
    2. 邊緣加速階段 - 用戶端透過全球 CDN 節點 (如 Cloudflare/Akamai) 獲取檔案，CDN 回源(pull)到 blob 儲存體時會進行緩存優化，針對熱門檔案啟用 edge caching 機制提升下載速度，同時觸發 AWS CloudFront 或 Azure CDN 的流量統計數據收集。
  - 範例架構：

  ```
  [用戶請求] → [CDN 節點] → (若快取未命中) → [Blob 儲存來源站]
  ```

  ::TIPS
  除非您有非常好的理由，否則請避免將像 S3 這樣的 Blob 儲存體用作您的主要資料庫。在典型的設置中，您將擁有一個核心資料庫，如 Postgres 或 DynamoDB，其中包含指向儲存在 S3 中的 Blob 的URL。這使您可以使用資料庫以非常低的延遲查詢和索引資料，同時仍然獲得廉價 Blob 儲存體的好處。
  ::

- 使用 Blob 儲存的關鍵原則

  - 避免直接取代資料庫，Blob缺乏索引、交易、查詢功能，效能與管理成本高昂。
  - 權限控管：
    - 設定 Blob 存取權限（如 S3 Bucket Policy），防止公開存取敏感檔案。
    - 使用 預簽署 URL（Pre-signed URL） 限制臨時存取權限。
  - 生命週期管理：
    - 自動歸檔或刪除舊檔案（如 S3 Lifecycle Policy），節省儲存成本。
    - 範例：將 1 年未存取的照片轉存至 Glacier 低價儲存層。
  - 版本控制：
    - 啟用檔案版本記錄（如 S3 Versioning），防止意外覆蓋或刪除。

- 特性：

  - Durability: Blob儲存服務以極高耐用性設計，採用資料複寫與刪除編碼技術，確保即使硬碟或伺服器故障，資料仍能安全無虞。
  - Scalability: 以AWS S3為代表的託管Blob儲存具備無限擴容能力，可儲存幾乎無限的數據並處理大量請求(帳戶層級限制除外)。在系統設計面試中，其擴展性通常視為既定前提無需特別考量。
  - Cost: 相較傳統資料庫，Blob儲存成本優勢顯著。例如AWS S3前50TB每月每GB僅0.023美元，遠低於DynamoDB前10TB每月每GB 1.25美元的費用
  - Security: 內建資料加密機制(靜態與傳輸中加密)，搭配精細權限管控功能，可嚴格管理資料存取者身分。
  - Upload and Download Directly from the Client: 支援直傳功能適用於圖像/影音等大型檔案存取的應用場景。預簽章URL是關鍵技術，能授予檔案上/下載的臨時存取權限。
  - Chunking: 大檔傳輸建議採用分塊上傳，除可續傳中斷任務外，亦能平行加速傳輸。AWS S3等現代儲存服務透過Multipart Upload API原生支援此機制，尤利於巨型檔案處理。

- 範例場景
  - YouTube
    - Blob 儲存影片檔案
    - DB存影片標題、描述、上傳者、觀看次數、標籤
  - Instagram
    - Blob 儲存圖片與影片
    - DB存發文者、讚數、留言、地理位置、標籤
  - Dropbox
    - Blob 儲存用戶上傳檔案
    - DB存檔案名稱、大小、版本歷史、共享權限、資料夾結構

## Search Optimized Database

有時你會需要將全文搜尋（full-text search）作為系統設計的一項功能來實現。全文搜尋指的是能在大規模文字資料中快速檢索出相關結果的能力，這與傳統基於精確匹配或範圍查詢的資料庫操作有本質區別。若未使用搜尋優化資料庫，你可能會執行類似以下的查詢：

```
SELECT * FROM documents WHERE document_text LIKE '%search_term%'
```

這種查詢不僅速度緩慢且效率低下，更難以擴展規模，因為它需要執行全表掃描（full table scan）。這意味著資料庫必須逐筆檢索每條記錄並比對查詢條件，而非透過索引或查找表快速定位。效能極差！

相較之下，專為搜尋優化的資料庫採用索引建立（indexing）、分詞（tokenization）和詞幹提取（stemming）等技術，能顯著提升查詢速度與效率。其核心原理在於建立稱為「倒排索引」（inverted indexes）的數據結構。倒排索引透過將詞彙映射至包含該詞的檔案來實現快速檢索，一個簡化的倒排索引結構範例如下：

```
{
  "word1": [doc1, doc2, doc3],
  "word2": [doc2, doc3, doc4],
  "word3": [doc1, doc3, doc4]
}
```

採用此機制後，資料庫無需掃描整張資料表，而是直接透過查詢詞彙快速定位相關檔案。效率飛躍！

實際應用案例相當直觀：以票務平台Ticketmaster為例，當需要從海量活動資料中過濾出符合條件的項目時；或是社交媒體平台Twitter需從數億則推文中篩選相關內容時，採用搜尋優化資料庫都是最佳選擇。

- 核心知識：
  - Inverted Indexes: 搜尋優化資料庫透過倒排索引實現高效檢索。這種數據結構將「詞彙」與「包含該詞的檔案」建立映射關係，舉例而言，當檢索「人工智慧」時，系統能立即鎖定所有包含此關鍵字的文件。
  - Tokenization: 分詞（Tokenization）是將連續文本切分為獨立詞元的過程。例如「自然語言處理」會被解析為「自然」、「語言」、「處理」三個詞元，作為建立倒排索引的基礎單元。
  - Stemming: 技術能將不同詞形還原至詞根。例如「running」、「ran」、「runs」皆會歸一化為「run」，大幅提升「run」作為檢索詞時的結果召回率。
  - Fuzzy Search: 模糊搜索（Fuzzy Search）功能可自動容錯使用者輸入的拼寫誤差或變體。其核心採用「編輯距離計算」（例如將「teh」校正為「the」需1次字元替換），多數搜尋資料庫皆預設提供此功能的參數化配置。
  - Scaling: 與傳統資料庫相似，搜尋優化資料庫透過「叢集節點擴增」與「數據分片」（Sharding）實現水平擴展。例如將10億筆資料分散至100個節點，每個節點僅需處理1千萬筆資料，藉此突破單機效能瓶頸。
